<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RFP Summarizer • Strategic Tender</title>
  <link rel="icon" href="logo.png">
  <style>
    :root { --bg:#f7f8fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --brand:#2563eb; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:960px;margin:48px auto;padding:0 16px;text-align:center}
    .logo{width:84px;height:auto;margin:0 auto 16px}
    h1{font-size:40px;margin:8px 0 24px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:24px;margin:0 auto;max-width:760px}
    .row{display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap}
    input[type="file"]{padding:10px;border:1px dashed #d1d5db;border-radius:12px;background:#fff}
    button{background:var(--brand);color:#fff;border:0;border-radius:12px;padding:10px 16px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .tabs{margin-top:14px;display:flex;gap:10px;justify-content:center}
    .tab{background:#e5edff;color:#123; border:0;border-radius:999px;padding:8px 14px}
    #spinner{display:none;margin-left:8px}
    #resultOutput{max-width:760px;margin:20px auto;text-align:left}
    .visually-hidden{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <img class="logo" src="logo.png" alt="Strategic Tender logo">
    <h1>RFP Summarizer</h1>

    <div class="card">
      <form id="summarizeForm" action="#" onsubmit="return false;">
        <div class="row">
          <input id="pdfInput" type="file" accept="application/pdf" />
          <button id="summarizeBtn" type="button" disabled>Summarize RFP</button>
          <span id="spinner" aria-live="polite">⏳ Working…</span>
        </div>
        <div class="tabs" aria-hidden="true">
          <button type="button" class="tab">Summary</button>
          <button type="button" class="tab">Raw JSON</button>
        </div>
      </form>
    </div>

    <div id="resultOutput"></div>
    <p class="visually-hidden" id="buildTag">build: inline-wire v1</p>
  </div>

  <!-- Inline wiring so the button always fires in production -->
  <script>
  (function(){
    const API_URL = 'https://summarize-rfp-v2-293196834043.us-central1.run.app/summarize_rfp';
    const $ = (id) => document.getElementById(id);
    const out = $('resultOutput');
    const btn = $('summarizeBtn');
    const file = $('pdfInput');
    const spin = $('spinner');

    function setBusy(b){
      if (spin) spin.style.display = b ? 'inline-block' : 'none';
      if (btn) { btn.disabled = b; btn.setAttribute('aria-busy', String(b)); }
    }
    function b64FromArrayBuffer(buf){
      let binary=''; const bytes=new Uint8Array(buf);
      for (let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]);
      return btoa(binary);
    }
    async function run(){
      try{
        const f = file && file.files && file.files[0];
        if(!f){ alert('Choose a PDF first.'); return; }
        setBusy(true);
        out.innerHTML = '<p>Uploading & summarizing…</p>';
        const buf = await f.arrayBuffer();
        const b64 = b64FromArrayBuffer(buf);

        const res = await fetch(API_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ filename: f.name, content: b64, options:{language:'en'} })
        });
        const text = await res.text();
        let json; try { json = JSON.parse(text); } catch(e){ throw new Error(`Non-JSON (${res.status}) ${text.slice(0,200)}…`); }
        if(!res.ok) throw new Error(json && json.error ? json.error : `HTTP ${res.status}`);
        const missing = Array.isArray(json.missing) ? json.missing : [];
        const html = json.summary_html || json.page_html || '';
        const notice = missing.length ? `<h2>Missing</h2><p>${missing.join(', ') || 'none'}</p>` : '';
        out.innerHTML = (notice ? notice : '') + '<h2>Summary</h2>' + (html || '<p>(no html)</p>');
      } catch(err){
        console.error(err);
        out.innerHTML = `<pre style="white-space:pre-wrap">Error: ${String(err.message || err)}</pre>`;
        alert(`Error: ${String(err.message || err)}`);
      } finally { setBusy(false); }
    }

    document.addEventListener('DOMContentLoaded', function(){
      setBusy(false);
      if (file && btn){
        btn.addEventListener('click', function(ev){ ev.preventDefault(); run(); });
        file.addEventListener('change', function(){ btn.disabled = !(file.files && file.files.length > 0); });
        // Enable immediately if browser restored prior selection
        btn.disabled = !(file.files && file.files.length > 0) ? true : false;
      }
    });
  })();
  </script>
</body>
</html>
